<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>リアルタイム階層プレビュー</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    #editor {
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 400px;
      white-space: pre-wrap;
      outline: none;
    }
    h1, h2, h3 {
      margin: 10px 0 5px;
    }
    .toggle-header {
      cursor: pointer;
      user-select: none;
    }
    .toggle-content {
      margin-left: 20px;
      display: none;
    }
    .toggle-open .toggle-content {
      display: block;
    }
  </style>
</head>
<body>
  <h2>リアルタイム階層エディター</h2>
  <div id="editor" contenteditable="true"></div>

  <script>
    const editor = document.getElementById("editor");

    function parseContent(text) {
      const lines = text.split("\n");
      const root = document.createElement("div");
      const stack = [{ level: -1, container: root }];

      lines.forEach(line => {
        const trimmed = line.replace(/^[　\s]*/, ''); // 全角・半角スペース削除
        const spaceCount = line.length - trimmed.length;

        if (!trimmed) return;

        const isToggle = trimmed.startsWith("▼");
        const content = isToggle ? trimmed.slice(1).trim() : trimmed;

        let element;
        if (spaceCount === 0) {
          element = document.createElement("h1");
          element.textContent = content;
        } else if (spaceCount === 1) {
          element = document.createElement("h2");
          element.textContent = content;
        } else if (spaceCount === 2) {
          element = document.createElement("h3");
          element.textContent = content;
        } else {
          element = document.createElement("div");
          element.textContent = content;
        }

        let parentLevel = spaceCount;
        while (stack.length && stack[stack.length - 1].level >= parentLevel) {
          stack.pop();
        }

        const parent = stack[stack.length - 1].container;

        if (isToggle) {
          const toggleWrapper = document.createElement("div");
          toggleWrapper.className = "toggle-section";

          const header = document.createElement("div");
          header.className = "toggle-header";
          header.textContent = "▼ " + content;
          header.onclick = () => {
            toggleWrapper.classList.toggle("toggle-open");
          };

          const contentDiv = document.createElement("div");
          contentDiv.className = "toggle-content";

          toggleWrapper.appendChild(header);
          toggleWrapper.appendChild(contentDiv);
          parent.appendChild(toggleWrapper);
          stack.push({ level: spaceCount, container: contentDiv });
        } else {
          parent.appendChild(element);
          if (spaceCount >= 3) {
            stack.push({ level: spaceCount, container: element });
          }
        }
      });

      return root.innerHTML;
    }

    function updatePreview() {
      const rawText = editor.innerText;
      const parsedHTML = parseContent(rawText);
      editor.innerHTML = parsedHTML;
      placeCaretAtEnd(editor);
    }

    function placeCaretAtEnd(el) {
      el.focus();
      document.execCommand('selectAll', false, null);
      document.getSelection().collapseToEnd();
    }

    editor.addEventListener("input", () => {
      updatePreview();
    });
  </script>
</body>
</html>