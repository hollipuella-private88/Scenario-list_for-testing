<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ライブ構造プレビュー</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    textarea {
      width: 100%;
      height: 200px;
      font-family: monospace;
      margin-bottom: 20px;
    }
    .preview {
      border: 1px solid #ccc;
      padding: 10px;
      white-space: normal;
    }
    .toggle-header {
      cursor: pointer;
      user-select: none;
      font-weight: bold;
    }
    .nested {
      margin-left: 20px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h2>リアルタイムプレビュー</h2>
  <textarea id="input" placeholder="例：&#10;見出しH1&#10; ▼トグル見出しH2&#10;   本文"></textarea>
  <div id="preview" class="preview"></div>

  <script>
    const input = document.getElementById("input");
    const preview = document.getElementById("preview");

    input.addEventListener("input", () => {
      const lines = input.value.split("\n");
      const root = document.createElement("div");
      const stack = [{ indent: -1, element: root }];

      lines.forEach(line => {
        const indentMatch = line.match(/^([\s　]*)/); // 半角・全角空白対応
        const indentStr = indentMatch ? indentMatch[0] : "";
        const indent = indentStr.replace(/[　]/g, " ").length; // 全角を半角に変換してカウント
        const text = line.trim();

        if (!text) return;

        let contentEl;

        // Hタグ or 本文の判定
        if (indent === 0) {
          contentEl = document.createElement("h1");
        } else if (indent === 1) {
          contentEl = document.createElement("h2");
        } else if (indent === 2) {
          contentEl = document.createElement("h3");
        } else {
          contentEl = document.createElement("div");
        }

        // ▼でトグル機能を追加
        if (text.startsWith("▼")) {
          const toggle = document.createElement("div");
          toggle.className = "toggle-header";
          toggle.textContent = text;
          const childrenContainer = document.createElement("div");
          childrenContainer.className = "nested hidden";

          toggle.addEventListener("click", () => {
            childrenContainer.classList.toggle("hidden");
          });

          contentEl = toggle;
          contentEl._toggleContainer = childrenContainer;
        } else {
          contentEl.textContent = text;
        }

        // 適切な親を探して挿入（階層構造）
        while (stack.length > 0 && indent <= stack[stack.length - 1].indent) {
          stack.pop();
        }

        const parent = stack[stack.length - 1].element;
        if (contentEl._toggleContainer) {
          parent.appendChild(contentEl);
          parent.appendChild(contentEl._toggleContainer);
          stack.push({ indent, element: contentEl._toggleContainer });
        } else {
          parent.appendChild(contentEl);
          stack.push({ indent, element: contentEl });
        }
      });

      preview.innerHTML = "";
      preview.appendChild(root);
    });
  </script>
</body>
</html>